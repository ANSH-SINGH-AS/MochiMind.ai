<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lock-in Mode - MochiMind.ai</title>
    <link rel="icon" href="logo.png">
    
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        mochi: { bg: '#fdfaec', light: '#f7b4a9', dark: '#ec7469', text: '#4a4a4a', white: '#ffffff' }
                    },
                    fontFamily: { heading: ['Fredoka', 'sans-serif'], body: ['Nunito', 'sans-serif'] },
                    animation: { 'pulse-slow': 'pulse 3s infinite' }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #fdfaec; color: #4a4a4a; font-family: 'Nunito', sans-serif; }
        h1, h2, h3, h4 { font-family: 'Fredoka', sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 2px solid white; border-radius: 1.5rem; box-shadow: 0 10px 30px rgba(236, 116, 105, 0.1); }
        .btn-primary { background-color: #ec7469; color: white; transition: all 0.2s; }
        .btn-primary:hover { background-color: #ff8a80; transform: translateY(-2px); }
        
        
        #pdf-render-container { overflow-y: auto; height: 80vh; position: relative; scroll-behavior: smooth; }
        .pdf-page { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .locked-overlay { position: absolute; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 50; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); border-top: 4px solid #ec7469; }
        
        
        .chat-bubble { padding: 10px 15px; border-radius: 15px; max-width: 80%; margin-bottom: 10px; font-size: 0.9rem; }
        .chat-user { background: #ec7469; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-ai { background: #f3f4f6; color: #374151; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ec7469; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #d65a50; }

        
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 18px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #ec7469;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #ec7469;
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(16px);
            -ms-transform: translateX(16px);
            transform: translateX(16px);
        }

        
        #tracker-video {
            filter: blur(4px);
            transform: scaleX(-1); 
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    
    <div id="auth-loading" class="fixed inset-0 bg-mochi-bg z-[100] flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-mochi-dark border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="font-heading text-xl text-mochi-dark">Loading your spaces...</p>
        </div>
    </div>

    
    <nav class="bg-white border-b border-mochi-light/30 px-6 py-3 flex justify-between items-center z-40 sticky top-0 h-24">
        <div class="flex items-center gap-4">
            <a href="app.html" class="w-10 h-10 block hover:scale-105 transition-transform">
                <img src="logo.png" alt="Logo" class="w-full h-full object-contain">
            </a>
            <div>
                <h1 class="text-xl font-bold text-mochi-dark">Lock-in Mode</h1>
                <p id="space-title-display" class="text-xs text-gray-400 font-bold hidden">Space Title</p>
            </div>
        </div>
        
        
        <div id="monitoring-toolbar" class="hidden flex items-center gap-6 h-full">
            
            
            <div class="flex flex-col items-center justify-center">
                <div class="relative w-16 h-10 bg-black rounded-lg overflow-hidden border-2 border-gray-200 mb-1">
                    <video id="tracker-video" class="w-full h-full object-cover" autoplay muted></video>
                    <div id="tracker-status" class="absolute bottom-0 w-full text-[6px] text-center bg-black/50 text-white font-bold">Off</div>
                </div>
                <div class="flex items-center gap-2">
                    <label class="switch">
                        <input type="checkbox" id="toggle-head">
                        <span class="slider round"></span>
                    </label>
                    <span class="text-[9px] font-bold text-gray-500 whitespace-nowrap">Head Track AI</span>
                </div>
            </div>

            
            <div class="flex flex-col items-center justify-center">
                <div id="tab-status-icon" class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 transition-colors mb-1">
                    <i data-lucide="monitor" class="w-5 h-5"></i>
                </div>
                <div class="flex items-center gap-2">
                    <label class="switch">
                        <input type="checkbox" id="toggle-tab">
                        <span class="slider round"></span>
                    </label>
                    <span class="text-[9px] font-bold text-gray-500">Tab Switch Check</span>
                </div>
            </div>

            
            <div class="flex flex-col items-center justify-center bg-gray-50 p-2 rounded-xl border border-gray-100">
                <span class="text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">Pomodoro Timer</span>
                <div class="flex items-center gap-3">
                    <div class="bg-white px-3 py-1 rounded-lg border border-gray-200 min-w-[60px] text-center">
                        <div id="pomo-display" class="text-lg font-heading font-bold text-mochi-dark tabular-nums">25:00</div>
                    </div>
                    <div class="flex gap-1">
                        <button id="pomo-start" class="w-8 h-8 flex items-center justify-center bg-green-100 rounded-lg hover:bg-green-200 text-green-700 transition-colors">
                            <i data-lucide="play" class="w-4 h-4"></i>
                        </button>
                        <button id="pomo-reset" class="w-8 h-8 flex items-center justify-center bg-red-100 rounded-lg hover:bg-red-200 text-red-700 transition-colors">
                            <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button id="nav-back-btn" class="text-sm font-bold text-gray-500 hover:text-mochi-dark flex items-center gap-1">
                <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Dashboard
            </button>
            <div id="user-avatar" class="w-8 h-8 rounded-full bg-gray-200"></div>
        </div>
    </nav>

    
    <main class="flex-grow container mx-auto p-6 relative">
        
        
        <div id="view-dashboard" class="space-y-6">
            <div class="flex justify-between items-end">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Your Study Spaces</h2>
                    <p class="text-gray-500">Select a space to lock in or create a new one.</p>
                </div>
                <button onclick="switchView('create')" class="btn-primary px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Create Space
                </button>
            </div>
            
            <div id="spaces-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <div class="col-span-full text-center py-20 text-gray-400 italic">Loading spaces...</div>
            </div>
        </div>

        
        <div id="view-create" class="hidden max-w-2xl mx-auto">
            <button onclick="switchView('dashboard')" class="text-sm text-gray-500 mb-4 flex items-center gap-1 hover:text-mochi-dark"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button>
            
            <div class="glass-panel p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Create New Lock-in Space</h2>
                
                <form id="create-space-form" class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Space Title</label>
                        <input type="text" id="space-title" required class="w-full p-3 bg-white border border-gray-200 rounded-xl focus:border-mochi-dark outline-none" placeholder="e.g., Biology Chapter 1">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <label class="cursor-pointer">
                            <input type="radio" name="space-type" value="video" checked onchange="toggleFormType()" class="peer sr-only">
                            <div class="p-4 border-2 border-gray-200 rounded-xl peer-checked:border-mochi-dark peer-checked:bg-red-50 text-center transition-all hover:bg-gray-50">
                                <i data-lucide="youtube" class="w-8 h-8 mx-auto mb-2 text-red-500"></i>
                                <span class="font-bold text-gray-700">YouTube Video</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="space-type" value="pdf" onchange="toggleFormType()" class="peer sr-only">
                            <div class="p-4 border-2 border-gray-200 rounded-xl peer-checked:border-mochi-dark peer-checked:bg-blue-50 text-center transition-all hover:bg-gray-50">
                                <i data-lucide="file-text" class="w-8 h-8 mx-auto mb-2 text-blue-500"></i>
                                <span class="font-bold text-gray-700">PDF Document</span>
                            </div>
                        </label>
                    </div>

                    
                    <div id="input-video-group" class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">YouTube URL</label>
                            <input type="url" id="video-url" class="w-full p-3 bg-white border border-gray-200 rounded-xl focus:border-mochi-dark outline-none" placeholder="https://youtube.com/watch?v=...">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Transcript</label>
                            <p class="text-xs text-gray-500 mb-2">Paste transcript from <a href="https://youtubetotranscript.com/" target="_blank" class="text-blue-500 underline">youtubetotranscript.com</a></p>
                            <textarea id="video-transcript" class="w-full p-3 bg-white border border-gray-200 rounded-xl h-32 focus:border-mochi-dark outline-none text-xs font-mono" placeholder="Paste full transcript here..."></textarea>
                        </div>
                    </div>

                    
                    <div id="input-pdf-group" class="hidden space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Upload PDF</label>
                            <input type="file" id="pdf-file" accept="application/pdf" class="w-full p-2 bg-white border border-gray-200 rounded-xl file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-mochi-light file:text-white hover:file:bg-mochi-dark">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Lock-in Interval</label>
                        <div class="flex gap-4">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="interval" value="5" class="peer sr-only">
                                <div class="py-2 text-center bg-white border rounded-lg peer-checked:bg-mochi-dark peer-checked:text-white font-bold">5%</div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="interval" value="15" class="peer sr-only">
                                <div class="py-2 text-center bg-white border rounded-lg peer-checked:bg-mochi-dark peer-checked:text-white font-bold">15%</div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="interval" value="25" checked class="peer sr-only">
                                <div class="py-2 text-center bg-white border rounded-lg peer-checked:bg-mochi-dark peer-checked:text-white font-bold">25%</div>
                            </label>
                        </div>
                    </div>

                    <button type="submit" id="create-btn" class="w-full btn-primary py-3 rounded-xl font-bold text-lg shadow-md">Start Lock-in Space</button>
                </form>
            </div>
        </div>

        
        <div id="view-study" class="hidden h-[80vh] flex gap-6 relative">
            
            
            <div class="flex-grow flex flex-col h-full bg-white rounded-2xl shadow-xl overflow-hidden relative">
                
                <div id="study-video-container" class="hidden flex flex-col h-full">
                    <div id="yt-player" class="flex-grow bg-black"></div>
                    <div class="bg-gray-900 p-4">
                        <div class="flex justify-between text-xs text-gray-400 mb-1 font-bold">
                            <span>Lock-in Progress</span>
                            <span id="video-timer">Next Check: --:--</span>
                        </div>
                        <div class="relative w-full h-3 bg-gray-700 rounded-full">
                            <div id="video-progress" class="absolute h-full bg-mochi-dark w-0 rounded-l-full transition-all duration-1000 z-10"></div>
                            
                            <div id="video-markers" class="absolute inset-0 w-full h-full flex items-center">
                                
                            </div>
                        </div>
                    </div>
                </div>

                
                <div id="study-pdf-container" class="hidden h-full relative flex">
                    
                    <div id="pdf-markers-container" class="w-1 absolute right-0 top-0 bottom-0 z-30 pointer-events-none">
                        
                    </div>

                    <div id="pdf-render-container" class="w-full h-full bg-gray-100 p-4"></div>
                    <div id="pdf-lock-overlay" class="hidden locked-overlay absolute inset-x-0 bottom-0 bg-white/95 h-[50%] flex flex-col items-center justify-center p-8 text-center border-t-4 border-mochi-dark">
                        <i data-lucide="lock" class="w-16 h-16 text-mochi-dark mb-4 animate-bounce"></i>
                        <h3 class="text-2xl font-bold text-gray-800">Content Locked!</h3>
                        <p class="text-gray-600 mb-6">You've reached the checkpoint. Prove your knowledge to continue.</p>
                        <button onclick="startLockinCheck()" class="btn-primary px-8 py-3 rounded-full font-bold shadow-lg animate-pulse">Start Knowledge Check</button>
                    </div>
                </div>
            </div>

            
            <div id="ai-tutor-panel" class="hidden absolute inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
                <div class="bg-white rounded-[2rem] w-full max-w-2xl h-[80vh] shadow-2xl flex flex-col overflow-hidden border-4 border-mochi-light">
                    
                    
                    <div class="bg-mochi-bg p-4 border-b border-mochi-light flex justify-between items-center">
                        <h3 class="text-xl font-bold text-mochi-dark flex items-center gap-2">
                            <i data-lucide="brain-circuit" class="w-6 h-6"></i> AI Tutor Check
                        </h3>
                        <span id="check-step-indicator" class="text-xs font-bold bg-white px-3 py-1 rounded-full border border-gray-200">Phase 1: Flashcards</span>
                    </div>

                    
                    <div id="tutor-content" class="flex-grow p-6 overflow-y-auto bg-gray-50 flex flex-col items-center justify-center relative">
                        
                        
                        <div id="phase-flashcards" class="w-full max-w-md hidden">
                            <div id="card-container" class="relative w-full aspect-[3/2] cursor-pointer perspective-1000 mb-6 group">
                                <div id="card-inner" class="relative w-full h-full transition-transform duration-700 transform-style-3d shadow-xl rounded-2xl">
                                    <div class="absolute w-full h-full backface-hidden bg-white border-2 border-mochi-light rounded-2xl flex items-center justify-center p-6 text-center">
                                        <p class="font-bold text-xl text-gray-700" id="fc-front">Generating...</p>
                                        <p class="absolute bottom-4 text-xs text-gray-400">Click to Flip</p>
                                    </div>
                                    <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-mochi-dark text-white rounded-2xl flex items-center justify-center p-6 text-center">
                                        <p class="font-bold text-lg" id="fc-back">...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span id="fc-counter" class="font-bold text-gray-400">1/5</span>
                                <button onclick="nextFlashcard()" class="btn-primary px-6 py-2 rounded-full font-bold">Next Card</button>
                            </div>
                        </div>

                        
                        <div id="phase-feynman" class="w-full h-full hidden flex flex-col">
                            <div class="bg-blue-50 p-4 rounded-xl mb-4 text-sm text-blue-800 border border-blue-200">
                                <strong>Tutor:</strong> Explain what you just learned in your own words. I'll be lenient!
                            </div>
                            <div id="chat-history" class="flex-grow overflow-y-auto mb-4 p-2"></div>
                            <div class="flex gap-2">
                                <input type="text" id="chat-input" class="flex-grow p-3 border rounded-xl outline-none focus:border-mochi-dark" placeholder="Type your explanation...">
                                <button onclick="sendChatMessage()" class="bg-mochi-dark text-white p-3 rounded-xl"><i data-lucide="send" class="w-5 h-5"></i></button>
                            </div>
                        </div>

                        
                        <div id="phase-quiz" class="w-full max-w-md hidden text-center">
                            <h4 id="quiz-question" class="text-lg font-bold text-gray-800 mb-6">Question goes here?</h4>
                            <div id="quiz-options" class="space-y-3 mb-6">
                                
                            </div>
                            <p id="quiz-score" class="text-sm font-bold text-gray-500">Score: 0/5</p>
                        </div>

                        
                        <div id="ai-loading" class="hidden absolute inset-0 bg-white/80 z-20 flex flex-col items-center justify-center">
                            <i data-lucide="loader-2" class="w-10 h-10 text-mochi-dark animate-spin mb-2"></i>
                            <p class="text-gray-500 font-bold animate-pulse">Consulting the Neural Net...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, push, update, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

       
        const firebaseConfig = {
REMOVED
        };

        const FACE_API_KEY = "REMOVED";
        const FACE_API_SECRET = "REMOVED";
        const GEMINI_API_KEY = "REMOVED";

       
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);

       
        let currentUser = null;
        let currentSpaceId = null;
        let currentSpaceData = null;
        let currentTextContext = "";
        let ytPlayer = null;
        let pdfDoc = null;
        let pomodoroInterval = null;
        let pomodoroTime = 25 * 60;
        let isPomoPaused = true;
        let headTrackingInterval = null;
        let isTabActive = true;
        let buzzerAudio = new Audio('buzzer.mp3');
        buzzerAudio.loop = true;
        
       
        let flashcards = [];
        let currentCardIdx = 0;
        let quizQuestions = [];
        let quizScore = 0;
        let quizQuestionIdx = 0;

       
        onAuthStateChanged(auth, (user) => {
            document.getElementById('auth-loading').classList.add('hidden');
            if (user) {
                currentUser = user;
                document.getElementById('user-avatar').innerHTML = `<img src="${user.photoURL}" class="w-full h-full rounded-full">`;
                loadDashboard();
                updateNavBackButton('dashboard');
            } else {
                window.location.href = 'index.html';
            }
        });

       
        function updateNavBackButton(viewName) {
            const btn = document.getElementById('nav-back-btn');
            if (!btn) return;
            if (viewName === 'dashboard') {
                btn.innerHTML = '<i data-lucide="layout-dashboard" class="w-4 h-4"></i> Dashboard';
                btn.onclick = () => { window.location.href = 'app.html'; };
            } else {
                btn.innerHTML = '<i data-lucide="layout-grid" class="w-4 h-4"></i> My Spaces';
                btn.onclick = () => switchView('dashboard');
            }
            lucide.createIcons();
        }

        window.switchView = (viewName) => {
            if(viewName !== 'study') {
                 stopMonitoring();
            }

            ['dashboard', 'create', 'study'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            if (viewName === 'study') document.getElementById('monitoring-toolbar').classList.remove('hidden');
            else document.getElementById('monitoring-toolbar').classList.add('hidden');

            if(viewName === 'dashboard') loadDashboard();
            updateNavBackButton(viewName);
        };

        function stopMonitoring() {
            if (headTrackingInterval) {
                clearInterval(headTrackingInterval);
                document.getElementById('toggle-head').checked = false;
            }
            if (pomodoroInterval) {
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                isPomoPaused = true;
                updatePomoIcon();
                document.getElementById('pomo-display').innerText = "25:00";
            }
            const videoEl = document.getElementById('tracker-video');
            if (videoEl.srcObject) {
                videoEl.srcObject.getTracks().forEach(t => t.stop());
                videoEl.srcObject = null;
            }
            buzzerAudio.pause();
            buzzerAudio.currentTime = 0;
        }

        window.toggleFormType = () => {
            const type = document.querySelector('input[name="space-type"]:checked').value;
            if (type === 'video') {
                document.getElementById('input-video-group').classList.remove('hidden');
                document.getElementById('input-pdf-group').classList.add('hidden');
            } else {
                document.getElementById('input-video-group').classList.add('hidden');
                document.getElementById('input-pdf-group').classList.remove('hidden');
            }
        };

       
        async function loadDashboard() {
            const grid = document.getElementById('spaces-grid');
            grid.innerHTML = '<div class="col-span-full text-center py-10"><i data-lucide="loader" class="animate-spin w-8 h-8 mx-auto text-mochi-dark"></i></div>';
            
            try {
                const snapshot = await get(child(ref(db), `users/${currentUser.uid.replace(/\./g, ',')}/spaces`));
                if (snapshot.exists()) {
                    grid.innerHTML = '';
                    snapshot.forEach(childSnap => {
                        const space = childSnap.val();
                        const id = childSnap.key;
                        const icon = space.type === 'video' ? 'youtube' : 'file-text';
                        const color = space.type === 'video' ? 'text-red-500' : 'text-blue-500';
                        const progress = space.currentSegment ? space.currentSegment : 0;
                        const totalSegs = Math.floor(100 / space.interval);
                        
                        grid.innerHTML += `
                            <div onclick="openSpace('${id}')" class="bg-white rounded-2xl p-6 shadow-sm hover:shadow-xl transition-all cursor-pointer border border-transparent hover:border-mochi-light group">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="p-3 bg-gray-50 rounded-xl group-hover:bg-mochi-bg transition-colors">
                                        <i data-lucide="${icon}" class="w-6 h-6 ${color}"></i>
                                    </div>
                                    <span class="text-xs font-bold text-gray-400 border px-2 py-1 rounded-full">${progress}/${totalSegs} Locked</span>
                                </div>
                                <h3 class="font-bold text-lg text-gray-800 mb-2 truncate">${space.title}</h3>
                                <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                                    <div class="bg-mochi-dark h-full" style="width: ${(progress/totalSegs)*100}%"></div>
                                </div>
                                <p class="text-xs text-gray-400 mt-2">Interval: ${space.interval}%</p>
                            </div>
                        `;
                    });
                    lucide.createIcons();
                } else {
                    grid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10">No spaces yet. Create one to lock in!</div>`;
                }
            } catch (e) {
                console.error(e);
                grid.innerHTML = `<div class="text-red-500">Error loading spaces</div>`;
            }
        }

       
        document.getElementById('create-space-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('create-btn');
            btn.innerHTML = 'Creating...';
            btn.disabled = true;

            try {
                const title = document.getElementById('space-title').value;
                const type = document.querySelector('input[name="space-type"]:checked').value;
                const interval = parseInt(document.querySelector('input[name="interval"]:checked').value);
                let url = '';
                let transcript = '';

                if (type === 'video') {
                    const rawUrl = document.getElementById('video-url').value;
                    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                    const match = rawUrl.match(regExp);
                    url = (match && match[2].length === 11) ? match[2] : null;
                    if(!url) throw new Error("Invalid YouTube URL");
                    transcript = document.getElementById('video-transcript').value;
                    if(!transcript) throw new Error("Transcript is required for AI generation.");
                } else {
                    const file = document.getElementById('pdf-file').files[0];
                    if (!file) throw new Error("Select a PDF file");
                    const storageRef = sRef(storage, `pdfs/${currentUser.uid}/${Date.now()}_${file.name}`);
                    const snapshot = await uploadBytes(storageRef, file);
                    url = await getDownloadURL(snapshot.ref);
                }

                const newSpace = {
                    title, type, url, transcript, interval,
                    currentSegment: 0,
                    createdAt: new Date().toISOString()
                };

                const newRef = push(ref(db, `users/${currentUser.uid.replace(/\./g, ',')}/spaces`));
                await set(newRef, newSpace);
                
                openSpace(newRef.key);

            } catch (err) {
                alert(err.message);
                btn.innerHTML = 'Start Lock-in Space';
                btn.disabled = false;
            }
        });

       
        
        function resetStudyState() {
            document.getElementById('pdf-render-container').innerHTML = '';
            document.getElementById('pdf-lock-overlay').classList.add('hidden');
            
            if(ytPlayer && typeof ytPlayer.stopVideo === 'function') {
                ytPlayer.stopVideo();
            }
            
            document.getElementById('video-markers').innerHTML = '';
            document.getElementById('pdf-markers-container').innerHTML = '';
            
            document.getElementById('ai-tutor-panel').classList.add('hidden');
            document.getElementById('phase-flashcards').classList.add('hidden');
            document.getElementById('phase-feynman').classList.add('hidden');
            document.getElementById('phase-quiz').classList.add('hidden');
            document.getElementById('chat-history').innerHTML = '';
            
            document.getElementById('video-progress').style.width = '0%';
            document.getElementById('video-timer').innerText = 'Next Check: --:--';
        }

        window.openSpace = async (spaceId) => {
            resetStudyState();
            currentSpaceId = spaceId;
            const snapshot = await get(child(ref(db), `users/${currentUser.uid.replace(/\./g, ',')}/spaces/${spaceId}`));
            currentSpaceData = snapshot.val();
            
            document.getElementById('space-title-display').innerText = currentSpaceData.title;
            document.getElementById('space-title-display').classList.remove('hidden');
            switchView('study');

            setupProgressMarkers(currentSpaceData.interval, currentSpaceData.currentSegment || 0);

            if (currentSpaceData.type === 'video') {
                document.getElementById('study-video-container').classList.remove('hidden');
                document.getElementById('study-pdf-container').classList.add('hidden');
                initYouTube(currentSpaceData.url);
            } else {
                document.getElementById('study-video-container').classList.add('hidden');
                document.getElementById('study-pdf-container').classList.remove('hidden');
                initPDF(currentSpaceData.url);
            }
        };

        function setupProgressMarkers(interval, currentSegment) {
           
            const vContainer = document.getElementById('video-markers');
            const pContainer = document.getElementById('pdf-markers-container');
            const totalSegments = Math.floor(100 / interval);
            vContainer.innerHTML = '';
            pContainer.innerHTML = '';
            
            for (let i = 1; i <= totalSegments; i++) {
                const leftPos = i * interval;
                if (leftPos >= 100) continue;
                
               
                const vMarker = document.createElement('div');
               
                const vColor = i <= currentSegment ? 'bg-green-400' : 'bg-yellow-400';
                vMarker.className = `absolute h-full w-1 transform -translate-x-1/2 z-20 ${vColor}`;
                vMarker.style.left = `${leftPos}%`;
                vContainer.appendChild(vMarker);

               
                const pMarker = document.createElement('div');
                const pColor = i <= currentSegment ? 'bg-green-400' : 'bg-yellow-400';
               
                pMarker.className = `absolute w-full h-3 transform -translate-y-1/2 z-20 ${pColor}`;
                pMarker.style.top = `${leftPos}%`;
                pContainer.appendChild(pMarker);
            }
        }

       
        function initYouTube(videoId) {
            if (ytPlayer) {
                ytPlayer.loadVideoById(videoId);
                checkVideoInterval();
                return;
            }

            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

            window.onYouTubeIframeAPIReady = () => {
                ytPlayer = new YT.Player('yt-player', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    events: {
                        'onStateChange': onPlayerStateChange
                    }
                });
            };
        }

        let videoCheckInterval;
        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                if (!videoCheckInterval) videoCheckInterval = setInterval(checkVideoProgress, 1000);
            } else {
                clearInterval(videoCheckInterval);
                videoCheckInterval = null;
            }
        }

        function checkVideoProgress() {
            if (!ytPlayer || !ytPlayer.getDuration) return;
            
            const duration = ytPlayer.getDuration();
            const current = ytPlayer.getCurrentTime();
            const intervalPercent = currentSpaceData.interval / 100;
            const segmentSize = duration * intervalPercent;
            const currentSegIndex = currentSpaceData.currentSegment || 0;
            const nextLockTime = (currentSegIndex + 1) * segmentSize;

            document.getElementById('video-progress').style.width = `${(current/duration)*100}%`;
            document.getElementById('video-timer').innerText = `Next Check: ${Math.max(0, Math.floor(nextLockTime - current))}s`;

            if (current >= nextLockTime && currentSegIndex < (100/currentSpaceData.interval)) {
                ytPlayer.pauseVideo();
                triggerLockIn();
            }
        }

       
        let totalPdfPages = 0;
        
        async function initPDF(url) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            
            try {
                const response = await fetch(url);
                const buffer = await response.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({data: buffer});
                
                pdfDoc = await loadingTask.promise;
                totalPdfPages = pdfDoc.numPages;
                
                const container = document.getElementById('pdf-render-container');
                container.innerHTML = ''; 

                for (let i = 1; i <= totalPdfPages; i++) {
                    const page = await pdfDoc.getPage(i);
                    const scale = 1.5;
                    const viewport = page.getViewport({ scale });
                    
                    const canvas = document.createElement('canvas');
                    canvas.className = 'pdf-page w-full';
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    const renderContext = { canvasContext: context, viewport: viewport };
                    await page.render(renderContext).promise;
                    
                    const wrapper = document.createElement('div');
                    wrapper.style.position = 'relative';
                    wrapper.appendChild(canvas);
                    container.appendChild(wrapper);
                }

                container.onscroll = () => {
                    const scrollPercent = container.scrollTop / (container.scrollHeight - container.clientHeight);
                    const intervalDecimal = currentSpaceData.interval / 100;
                    const currentSegIndex = currentSpaceData.currentSegment || 0;
                    const lockThreshold = (currentSegIndex + 1) * intervalDecimal;
                    
                    if (scrollPercent >= lockThreshold && currentSegIndex < (100/currentSpaceData.interval)) {
                        document.getElementById('pdf-lock-overlay').classList.remove('hidden');
                        container.style.overflow = 'hidden'; 
                    }
                };
            } catch (error) {
                console.error("PDF Load Error:", error);
                document.getElementById('pdf-render-container').innerHTML = `<div class="p-10 text-center text-red-500">Failed to load PDF. CORS restriction or invalid file.<br>Error: ${error.message}</div>`;
            }
        }

        async function extractPdfText(startPage, endPage) {
            let extractedText = "";
           
            const safeStart = Math.max(1, startPage);
            const safeEnd = Math.min(totalPdfPages, endPage);
            
            for (let i = safeStart; i <= safeEnd; i++) {
                const page = await pdfDoc.getPage(i);
                const textContent = await page.getTextContent();
                const pageStrings = textContent.items.map(item => item.str);
                extractedText += pageStrings.join(" ") + "\n";
            }
            return extractedText;
        }

       
        window.triggerLockIn = () => {
             startLockinCheck();
        };

        window.startLockinCheck = async () => {
            document.getElementById('ai-tutor-panel').classList.remove('hidden');
            document.getElementById('ai-loading').classList.remove('hidden');
            document.getElementById('phase-flashcards').classList.add('hidden');
            document.getElementById('phase-feynman').classList.add('hidden');
            document.getElementById('phase-quiz').classList.add('hidden');
            
           
            let textSegment = "";
            const currentSegIndex = currentSpaceData.currentSegment || 0;
            
            if (currentSpaceData.type === 'video') {
                const chunks = Math.floor(100 / currentSpaceData.interval);
                const transcriptLen = currentSpaceData.transcript.length;
                const chunkSize = Math.floor(transcriptLen / chunks);
                const start = currentSegIndex * chunkSize;
                textSegment = currentSpaceData.transcript.substring(start, start + chunkSize);
            } else {
               
                const intervalDecimal = currentSpaceData.interval / 100;
               
                const startPage = Math.floor((currentSegIndex * intervalDecimal) * totalPdfPages) + 1;
                const endPage = Math.floor(((currentSegIndex + 1) * intervalDecimal) * totalPdfPages);
                textSegment = await extractPdfText(startPage, Math.max(startPage, endPage));
            }

            if (!textSegment || textSegment.trim().length < 50) {
                 alert("Content extraction failed or too short. Proceeding with generic mode.");
                 textSegment = "The user has studied a segment of content. Generate generic study questions based on the title: " + currentSpaceData.title;
            }
            
           
            currentTextContext = textSegment;

           
            try {
                const prompt = `Generate 5 study flashcards based on this text. Return ONLY a valid JSON array of objects with keys "front" and "back". Do not use markdown blocks. Text: ${textSegment.substring(0, 5000)}`;
                const response = await callGemini(prompt);
                
                let cleanJson = response;
                const jsonStart = response.indexOf('[');
                const jsonEnd = response.lastIndexOf(']') + 1;
                if (jsonStart !== -1 && jsonEnd !== -1) {
                    cleanJson = response.substring(jsonStart, jsonEnd);
                }
                
                flashcards = JSON.parse(cleanJson);
                currentCardIdx = 0;
                showFlashcardUI();
            } catch (e) {
                console.error("AI Error", e);
                alert("AI Brain Freeze! " + e.message + " - Please try again.");
                document.getElementById('ai-tutor-panel').classList.add('hidden');
            }
        };

        async function callGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            
            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                throw new Error("Invalid AI Response. Please check API key/quota.");
            }
            return data.candidates[0].content.parts[0].text;
        }

        function showFlashcardUI() {
            document.getElementById('ai-loading').classList.add('hidden');
            document.getElementById('phase-flashcards').classList.remove('hidden');
            document.getElementById('check-step-indicator').innerText = 'Phase 1: Flashcards';
            renderCard();
        }

        window.renderCard = () => {
            const card = flashcards[currentCardIdx];
            document.getElementById('fc-front').innerText = card.front;
            document.getElementById('fc-back').innerText = card.back;
            document.getElementById('fc-counter').innerText = `${currentCardIdx+1}/${flashcards.length}`;
            
            const cardInner = document.getElementById('card-inner');
            cardInner.style.transform = 'rotateY(0deg)';
            
            document.getElementById('card-container').onclick = () => {
                const current = cardInner.style.transform;
                cardInner.style.transform = current === 'rotateY(180deg)' ? 'rotateY(0deg)' : 'rotateY(180deg)';
            };
        };

        window.nextFlashcard = () => {
            if (currentCardIdx < flashcards.length - 1) {
                currentCardIdx++;
                renderCard();
            } else {
                startFeynmanPhase();
            }
        };

        function startFeynmanPhase() {
            document.getElementById('phase-flashcards').classList.add('hidden');
            document.getElementById('phase-feynman').classList.remove('hidden');
            document.getElementById('check-step-indicator').innerText = 'Phase 2: Feynman Check';
            document.getElementById('chat-history').innerHTML = ''; 
        }

        window.sendChatMessage = async () => {
            const input = document.getElementById('chat-input');
            const msg = input.value;
            if (!msg) return;

            const chatHistory = document.getElementById('chat-history');
            chatHistory.innerHTML += `<div class="chat-bubble chat-user">${msg}</div>`;
            input.value = '';

            chatHistory.innerHTML += `<div class="chat-bubble chat-ai animate-pulse">Thinking...</div>`;
            
            const prompt = `You are a lenient tutor. The user is explaining a concept. If their explanation "${msg}" is reasonably correct or shows effort, reply with exactly "PASSED". If not, ask a clarifying question. Keep it short.`;
            
            try {
                const reply = await callGemini(prompt);
                chatHistory.lastElementChild.remove();
                
                if (reply.includes("PASSED")) {
                    chatHistory.innerHTML += `<div class="chat-bubble chat-ai bg-green-100 text-green-800 font-bold">Great explanation! Moving to Quiz.</div>`;
                    setTimeout(startQuizPhase, 2000);
                } else {
                    chatHistory.innerHTML += `<div class="chat-bubble chat-ai">${reply}</div>`;
                }
                chatHistory.scrollTop = chatHistory.scrollHeight;
            } catch (e) {
                chatHistory.lastElementChild.remove();
                alert("AI Error during chat.");
            }
        };

        async function startQuizPhase() {
            document.getElementById('phase-feynman').classList.add('hidden');
            document.getElementById('ai-loading').classList.remove('hidden'); 
            document.getElementById('check-step-indicator').innerText = 'Phase 3: Final Quiz';

            try {
               
                const prompt = `Generate 5 multiple choice questions based on the text below. 
                Return ONLY a JSON array with this structure: 
                [{"question": "string", "options": ["string", "string", "string", "string"], "correctIndex": number}]
                Do not include markdown formatting.
                
                TEXT: ${currentTextContext.substring(0, 5000)}`;
                
                const response = await callGemini(prompt);
                
                let cleanJson = response;
                const jsonStart = response.indexOf('[');
                const jsonEnd = response.lastIndexOf(']') + 1;
                if (jsonStart !== -1 && jsonEnd !== -1) {
                    cleanJson = response.substring(jsonStart, jsonEnd);
                }
                
                quizQuestions = JSON.parse(cleanJson);
                quizScore = 0;
                quizQuestionIdx = 0;
                
                document.getElementById('ai-loading').classList.add('hidden');
                document.getElementById('phase-quiz').classList.remove('hidden');
                renderQuizQuestion();
            } catch (e) {
                console.error("Quiz Gen Error", e);
                alert("Error generating quiz. Retrying...");
                setTimeout(startQuizPhase, 1000);
            }
        }

        function renderQuizQuestion() {
            if (quizQuestionIdx >= quizQuestions.length) {
                finishLockIn();
                return;
            }
            
            const q = quizQuestions[quizQuestionIdx];
            document.getElementById('quiz-question').innerText = q.question;
            const optsContainer = document.getElementById('quiz-options');
            optsContainer.innerHTML = '';
            
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full p-3 text-left border rounded-xl hover:bg-gray-50 transition-colors";
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(idx, q.correctIndex, btn);
                optsContainer.appendChild(btn);
            });
            document.getElementById('quiz-score').innerText = `Score: ${quizScore}/5`;
        }

        function checkAnswer(selected, correct, btn) {
            const btns = document.getElementById('quiz-options').querySelectorAll('button');
            btns.forEach(b => b.disabled = true);

            if (selected === correct) {
                btn.classList.add('bg-green-100', 'border-green-500');
                quizScore++;
            } else {
                btn.classList.add('bg-red-100', 'border-red-500');
            }
            
            document.getElementById('quiz-score').innerText = `Score: ${quizScore}/5`;

            setTimeout(() => {
                quizQuestionIdx++;
                renderQuizQuestion();
            }, 1000);
        }

        async function finishLockIn() {
            if (quizScore >= 3) {
                alert(" Segment Unlocked! Great job.");
                document.getElementById('ai-tutor-panel').classList.add('hidden');
                
                const nextSeg = (currentSpaceData.currentSegment || 0) + 1;
                await update(child(ref(db), `users/${currentUser.uid.replace(/\./g, ',')}/spaces/${currentSpaceId}`), {
                    currentSegment: nextSeg
                });
                
                currentSpaceData.currentSegment = nextSeg;
                setupProgressMarkers(currentSpaceData.interval, nextSeg);
                
                if (currentSpaceData.type === 'video') {
                    ytPlayer.playVideo();
                } else {
                    document.getElementById('pdf-lock-overlay').classList.add('hidden');
                    document.getElementById('pdf-render-container').style.overflow = 'auto';
                }
            } else {
                alert(`Score: ${quizScore}/5. You need 3/5 to proceed. Retrying quiz...`);
                quizScore = 0;
                quizQuestionIdx = 0;
                renderQuizQuestion(); 
            }
        }

       

       
        const pomoDisplay = document.getElementById('pomo-display');
        
        function updatePomoIcon() {
           
            const btn = document.getElementById('pomo-start');
            const icon = btn.querySelector('svg') || btn.querySelector('i');
            
            if (isPomoPaused) {
                btn.classList.replace('bg-yellow-100', 'bg-green-100');
                btn.classList.replace('text-yellow-700', 'text-green-700');
               
                if(icon) {
                    
                     btn.innerHTML = `<i data-lucide="play" class="w-4 h-4"></i>`;
                }
            } else {
                btn.classList.replace('bg-green-100', 'bg-yellow-100');
                btn.classList.replace('text-green-700', 'text-yellow-700');
                if(icon) {
                     btn.innerHTML = `<i data-lucide="pause" class="w-4 h-4"></i>`;
                }
            }
            lucide.createIcons();
        }

        document.getElementById('pomo-start').onclick = () => {
            if (pomodoroInterval) {
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                isPomoPaused = true;
                updatePomoIcon();
            } else {
                isPomoPaused = false;
                updatePomoIcon();
                pomodoroInterval = setInterval(() => {
                    pomodoroTime--;
                    const m = Math.floor(pomodoroTime / 60).toString().padStart(2, '0');
                    const s = (pomodoroTime % 60).toString().padStart(2, '0');
                    pomoDisplay.innerText = `${m}:${s}`;
                    if (pomodoroTime <= 0) {
                        playBuzzer();
                        clearInterval(pomodoroInterval);
                        alert("Pomodoro Complete!");
                        isPomoPaused = true;
                        updatePomoIcon();
                    }
                }, 1000);
            }
        };

        document.getElementById('pomo-reset').onclick = () => {
            clearInterval(pomodoroInterval);
            pomodoroInterval = null;
            pomodoroTime = 25 * 60;
            pomoDisplay.innerText = "25:00";
            isPomoPaused = true;
            updatePomoIcon();
        };

       
        document.addEventListener("visibilitychange", () => {
            if (document.getElementById('toggle-tab').checked && document.hidden) {
                playBuzzer();
                document.title = " COME BACK!";
            } else {
                document.title = "Lock-in Mode";
                if(buzzerAudio && !buzzerAudio.paused) {
                    buzzerAudio.pause();
                    buzzerAudio.currentTime = 0;
                }
            }
        });

       
        document.getElementById('toggle-head').onchange = async (e) => {
            if (e.target.checked) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    document.getElementById('tracker-video').srcObject = stream;
                    startTrackingLoop();
                } catch(err) {
                    alert("Camera access denied");
                    e.target.checked = false;
                }
            } else {
                clearInterval(headTrackingInterval);
                const stream = document.getElementById('tracker-video').srcObject;
                if(stream) stream.getTracks().forEach(t => t.stop());
                buzzerAudio.pause();
            }
        };

        function startTrackingLoop() {
            headTrackingInterval = setInterval(async () => {
                const videoEl = document.getElementById('tracker-video');
                const canvas = document.createElement('canvas');
                canvas.width = videoEl.videoWidth;
                canvas.height = videoEl.videoHeight;
                canvas.getContext('2d').drawImage(videoEl, 0, 0);
                
                canvas.toBlob(async (blob) => {
                    const form = new FormData();
                    form.append("api_key", FACE_API_KEY);
                    form.append("api_secret", FACE_API_SECRET);
                    form.append("image_file", blob);
                    
                    try {
                        const res = await fetch("https://api-us.faceplusplus.com/facepp/v3/detect?return_attributes=headpose", { 
                            method: "POST", body: form 
                        });
                        const data = await res.json();
                        
                        if (data.faces && data.faces.length > 0) {
                            const pose = data.faces[0].attributes.headpose;
                            if (Math.abs(pose.yaw_angle) > 30 || Math.abs(pose.pitch_angle) > 25) {
                                document.getElementById('tracker-status').innerText = "Distracted!";
                                document.getElementById('tracker-status').classList.replace('bg-black/50', 'bg-red-500');
                                playBuzzer();
                            } else {
                                document.getElementById('tracker-status').innerText = "Focused";
                                document.getElementById('tracker-status').classList.replace('bg-red-500', 'bg-green-500');
                                buzzerAudio.pause();
                            }
                        }
                    } catch (err) { console.log("Tracking error", err); }
                }, 'image/jpeg');
            }, 3000); 
        }

        function playBuzzer() {
            buzzerAudio.play().catch(e => console.log("Audio play failed (user interaction needed)", e));
        }

        lucide.createIcons();
    </script>
</body>
</html>