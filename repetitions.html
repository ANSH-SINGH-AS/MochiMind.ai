<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spaced Repetition - MochiMind.ai</title>
    <link rel="icon" href="logo.png">
    
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "4773be92-d24f-4e90-99a5-f091d209ef51",
          safari_web_id: "web.onesignal.auto.4e197e53-7d58-4e85-b8d7-9d182b545f43",
          notifyButton: {
            enable: true,
          },
          serviceWorkerPath: "OneSignalSDK-v16-ServiceWorker/OneSignalSDKWorker.js",
          serviceWorkerParam: { scope: "/OneSignalSDK-v16-ServiceWorker/" },
        });
      });
    </script>

    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        mochi: { bg: '#fdfaec', light: '#f7b4a9', dark: '#ec7469', text: '#4a4a4a', white: '#ffffff' }
                    },
                    fontFamily: { heading: ['Fredoka', 'sans-serif'], body: ['Nunito', 'sans-serif'] },
                    animation: { 
                        'float': 'float 6s ease-in-out infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #fdfaec; color: #4a4a4a; font-family: 'Nunito', sans-serif; }
        h1, h2, h3 { font-family: 'Fredoka', sans-serif; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid white;
            border-radius: 2rem;
            box-shadow: 0 10px 30px rgba(236, 116, 105, 0.1);
        }

        .btn-primary {
            background-color: #ec7469;
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #ff8a80;
            transform: translateY(-2px);
        }

        
        .flatpickr-calendar {
            border-radius: 1rem;
            border: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            font-family: 'Nunito', sans-serif;
        }
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day:hover, .flatpickr-day:focus {
            background: #ec7469;
            border-color: #ec7469;
        }
        .flatpickr-months .flatpickr-month {
            background: #ec7469;
            color: white;
            fill: white;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            padding-top: 10px;
        }
        .flatpickr-current-month .flatpickr-monthDropdown-months, 
        .flatpickr-current-month input.cur-year {
            color: white;
            font-weight: 700;
        }

        
        .tab-btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 0.875rem;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .tab-btn.active {
            background-color: #ec7469;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .tab-btn.inactive {
            background-color: white;
            color: #6b7280;
            border-color: #f3f4f6;
        }
        .tab-btn.inactive:hover {
            border-color: #f7b4a9;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    
    <div id="auth-loading" class="fixed inset-0 bg-mochi-bg z-[100] flex items-center justify-center">
        <div class="text-center">
             <div class="w-16 h-16 border-4 border-mochi-dark border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
             <p class="font-heading text-xl text-mochi-dark">Syncing Schedule...</p>
        </div>
    </div>

    
    <nav class="bg-white border-b border-mochi-light/30 px-6 py-3 flex justify-between items-center z-40 sticky top-0 h-20">
        <div class="flex items-center gap-4">
            <a href="app.html" class="w-10 h-10 block hover:scale-105 transition-transform">
                <img src="logo.png" alt="Logo" class="w-full h-full object-contain">
            </a>
            <div>
                <h1 class="text-xl font-bold text-mochi-dark">Spaced Repetition</h1>
                <p class="text-xs text-gray-400 font-bold">Never Forget What You Learn</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
             <a href="app.html" class="text-sm font-bold text-gray-500 hover:text-mochi-dark flex items-center gap-1">
                <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Dashboard
            </a>
            <div id="user-avatar" class="w-8 h-8 rounded-full bg-gray-200"></div>
        </div>
    </nav>

    
    <main class="flex-grow container mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        
        <div class="lg:col-span-5 space-y-6">
            <div class="glass-panel p-8 relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-blue-100 rounded-full blur-2xl opacity-50"></div>
                
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <i data-lucide="bell-plus" class="text-mochi-dark"></i> Create Campaign
                </h2>

                <form id="reminder-form" class="space-y-5">
                    
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-1 ml-1">Topic Title</label>
                            <input type="text" id="topic-title" required class="w-full p-3 bg-white border border-gray-200 rounded-xl focus:border-mochi-dark outline-none font-bold text-gray-700" placeholder="e.g. Thermodynamics">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-1 ml-1">Description (Flashcard)</label>
                            <textarea id="topic-desc" required class="w-full p-3 bg-white border border-gray-200 rounded-xl focus:border-mochi-dark outline-none text-sm h-24 resize-none" placeholder="What specific concept do you need to review?"></textarea>
                        </div>
                    </div>

                    
                    <div class="bg-gray-50 p-1.5 rounded-full flex">
                        <button type="button" onclick="setMode('default')" id="btn-default" class="tab-btn active w-1/2">
                            Standard (2-3-5-7)
                        </button>
                        <button type="button" onclick="setMode('custom')" id="btn-custom" class="tab-btn inactive w-1/2">
                            Custom Dates
                        </button>
                    </div>

                    
                    <div id="mode-default" class="block animate-fade-in">
                        <label class="block text-sm font-bold text-gray-600 mb-2 ml-1">Daily Notification Time</label>
                        <div class="relative">
                            <i data-lucide="clock" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 z-10"></i>
                            <input type="text" id="default-time" class="w-full pl-10 p-3 bg-white border border-gray-200 rounded-xl focus:border-mochi-dark outline-none cursor-pointer" placeholder="Select Time">
                        </div>
                        <p class="text-xs text-gray-400 mt-2 ml-1">
                            <i data-lucide="info" class="w-3 h-3 inline"></i> Schedules for Days 2, 3, 5, 7 & 30 automatically.
                        </p>
                    </div>

                    
                    <div id="mode-custom" class="hidden animate-fade-in">
                        <label class="block text-sm font-bold text-gray-600 mb-2 ml-1">Select Dates & Time</label>
                        <div class="relative">
                             <i data-lucide="calendar" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 z-10"></i>
                            <input type="text" id="custom-dates" class="w-full pl-10 p-3 bg-white border border-gray-200 rounded-xl focus:border-mochi-dark outline-none cursor-pointer" placeholder="Pick multiple dates...">
                        </div>
                    </div>

                    
                    <div class="pt-4 flex gap-3">
                        <button type="button" onclick="previewNotification()" class="flex-1 bg-white border-2 border-mochi-light text-mochi-dark py-3 rounded-xl font-bold hover:bg-red-50 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="smartphone"></i> Preview
                        </button>
                        <button type="submit" class="flex-[2] btn-primary py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                            <i data-lucide="calendar-check-2"></i> Schedule
                        </button>
                    </div>
                </form>
            </div>
        </div>

        
        <div class="lg:col-span-7 space-y-6">
            <div class="flex justify-between items-end mb-2">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Your Learning Queue</h2>
                    <p class="text-gray-500 text-sm">Upcoming reviews across all topics.</p>
                </div>
                <div class="bg-white px-4 py-2 rounded-full shadow-sm text-xs font-bold text-gray-500 border border-gray-100">
                    <span id="queue-count">0</span> Pending
                </div>
            </div>

            <div id="schedule-container" class="space-y-4 h-[70vh] overflow-y-auto pr-2 pb-10">
                
                <div class="text-center py-20 opacity-50">
                    <i data-lucide="calendar-off" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                    <p class="font-bold text-gray-400">No active repetitions.</p>
                </div>
            </div>
        </div>
    </main>

    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

       
        const firebaseConfig = {
REMOVED
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

       
        const ONESIGNAL_APP_ID = "REMOVED";
        const ONESIGNAL_REST_KEY = "REMOVED";

        async function scheduleOneSignalPush(uid, title, description, sendAfterISO) {
            const res = await fetch("https://api.onesignal.com/notifications", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Key ${ONESIGNAL_REST_KEY}`
                },
                body: JSON.stringify({
                    app_id: ONESIGNAL_APP_ID,
                    include_aliases: { external_id: [uid] },
                    target_channel: "push",
                    contents: { en: description || "Time to review!" },
                    headings: { en: title },
                    send_after: sendAfterISO,
                    isAnyWeb: true,
                    isIos: false,
                    isAndroid: false,
                    isHuawei: false,
                    isAdm: false
                })
            });
            return res.ok ? (await res.json()).id : null;
        }

        let currentUser = null;
        let currentMode = 'default';

       
        const timePicker = flatpickr("#default-time", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            defaultDate: "10:00",
            disableMobile: "true"
        });

        const minDateTwoDaysAhead = (() => {
            const d = new Date();
            d.setDate(d.getDate() + 2);
            return d;
        })();
        const multiPicker = flatpickr("#custom-dates", {
            mode: "multiple",
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            minDate: minDateTwoDaysAhead,
            disableMobile: "true"
        });

       
        onAuthStateChanged(auth, (user) => {
            document.getElementById('auth-loading').classList.add('hidden');
            if (user) {
                currentUser = user;
                document.getElementById('user-avatar').innerHTML = `<img src="${user.photoURL}" class="w-full h-full rounded-full">`;
                
               
                OneSignalDeferred.push(async function(OneSignal) {
                    if (Notification.permission === "granted") {
                        await OneSignal.login(user.uid);
                        if (user.email) OneSignal.User.addEmail(user.email);
                    }
                });

                loadSchedule();
            } else {
                window.location.href = 'index.html';
            }
        });

       
        window.setMode = (mode) => {
            currentMode = mode;
            if (mode === 'default') {
                document.getElementById('btn-default').className = "tab-btn active w-1/2";
                document.getElementById('btn-custom').className = "tab-btn inactive w-1/2";
                document.getElementById('mode-default').classList.remove('hidden');
                document.getElementById('mode-custom').classList.add('hidden');
            } else {
                document.getElementById('btn-default').className = "tab-btn inactive w-1/2";
                document.getElementById('btn-custom').className = "tab-btn active w-1/2";
                document.getElementById('mode-default').classList.add('hidden');
                document.getElementById('mode-custom').classList.remove('hidden');
            }
        };

       
        window.previewNotification = () => {
            const title = document.getElementById('topic-title').value || "Sample Topic";
            const body = document.getElementById('topic-desc').value || "This is how your reminder will look.";
            
           
            if (Notification.permission === "granted") {
                new Notification(`ðŸ”” Review: ${title}`, {
                    body: body,
                    icon: "logo.png"
                });
            } else {
               
                OneSignalDeferred.push(function(OneSignal) {
                    OneSignal.Slidedown.promptPush();
                    alert("Please allow notifications first!");
                });
            }
        };

       
        document.getElementById('reminder-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('topic-title').value;
            const desc = document.getElementById('topic-desc').value;
            let scheduleDates = [];

            if (currentMode === 'default') {
                const timeStr = document.getElementById('default-time').value;
                if (!timeStr) { alert("Please select a time"); return; }
                const [hour, minute] = timeStr.split(':');
                
               
                [2, 3, 5, 7, 30].forEach(days => {
                    const date = new Date();
                    date.setDate(date.getDate() + days);
                    date.setHours(hour, minute, 0, 0);
                    scheduleDates.push(date.toISOString());
                });

            } else {
                const selectedDates = multiPicker.selectedDates;
                if (selectedDates.length === 0) { alert("Please pick at least one date."); return; }
                scheduleDates = selectedDates.map(d => d.toISOString());
            }

            if (Notification.permission !== "granted") {
                alert("Please allow notifications first (use the bell icon or preview button).");
                return;
            }

            try {
                const campaignRef = push(ref(db, `users/${currentUser.uid}/repetitions`));
                await set(campaignRef, {
                    title,
                    description: desc,
                    dates: scheduleDates,
                    createdAt: new Date().toISOString(),
                    status: 'active'
                });

               
                OneSignalDeferred.push(async function(OneSignal) {
                    await OneSignal.login(currentUser.uid);
                    if (currentUser.email) OneSignal.User.addEmail(currentUser.email);
                    let scheduled = 0;
                    for (const isoDate of scheduleDates) {
                        const sendAt = new Date(isoDate);
                        if (sendAt > new Date()) {
                            const id = await scheduleOneSignalPush(currentUser.uid, title, desc, sendAt.toISOString());
                            if (id) scheduled++;
                        }
                    }
                    alert(`âœ… Successfully scheduled ${scheduleDates.length} reminders!${scheduled < scheduleDates.length ? ` (${scheduled} push notifications queued)` : ""}`);
                    document.getElementById('reminder-form').reset();
                    timePicker.clear();
                    multiPicker.clear();
                });
            } catch (error) {
                console.error("Error scheduling:", error);
                alert("Failed to save schedule.");
            }
        });

       
        function loadSchedule() {
            const container = document.getElementById('schedule-container');
            const countBadge = document.getElementById('queue-count');

            const repRef = ref(db, `users/${currentUser.uid}/repetitions`);
            
            onValue(repRef, (snapshot) => {
                container.innerHTML = '';
                if (!snapshot.exists()) {
                    container.innerHTML = `
                        <div class="text-center py-20 opacity-50">
                            <i data-lucide="calendar-off" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                            <p class="font-bold text-gray-400">No active repetitions.</p>
                        </div>`;
                    countBadge.innerText = '0';
                    return;
                }

                let totalPending = 0;
                const campaigns = [];
                
                snapshot.forEach(child => {
                    campaigns.push({ id: child.key, ...child.val() });
                });

               
                campaigns.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

                campaigns.forEach(camp => {
                    const futureDates = camp.dates.filter(d => new Date(d) > new Date());
                    totalPending += futureDates.length;
                    
                    if (futureDates.length === 0) return;

                   
                    const nextDate = new Date(futureDates[0]);
                    const formattedDate = nextDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' });

                    const div = document.createElement('div');
                    div.className = "bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center group hover:border-mochi-light transition-colors";
                    div.innerHTML = `
                        <div class="flex items-start gap-4">
                            <div class="bg-blue-50 p-3 rounded-xl text-blue-500">
                                <i data-lucide="repeat" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">${camp.title}</h3>
                                <p class="text-xs text-gray-400 mb-2 truncate max-w-xs">${camp.description}</p>
                                <div class="flex items-center gap-2">
                                    <span class="bg-mochi-bg text-mochi-dark text-xs font-bold px-2 py-1 rounded-md border border-mochi-light">
                                        Next: ${formattedDate}
                                    </span>
                                    <span class="text-xs text-gray-400 font-bold">+${futureDates.length - 1} more</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteCampaign('${camp.id}')" class="p-2 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    `;
                    container.appendChild(div);
                });
                
                countBadge.innerText = totalPending;
                lucide.createIcons();
            });
        }

        window.deleteCampaign = async (id) => {
            if(confirm("Delete this repetition schedule?")) {
                await remove(ref(db, `users/${currentUser.uid}/repetitions/${id}`));
            }
        };
        
        lucide.createIcons();
    </script>
</body>
</html>